<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<title>Claim Capture — Guided</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  body{font-family:Inter,Arial,sans-serif;max-width:720px;margin:18px auto;padding:0 14px;color:#111}
  h2{margin:0 0 8px}
  .slot{margin-top:14px;padding:12px;border:1px solid #eee;border-radius:8px;background:#fafafa}
  video{width:100%;border-radius:8px;background:#000;max-height:50vh;object-fit:cover}
  .overlay{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:70%;height:22%;border:3px dashed rgba(255,255,255,0.9);border-radius:6px;pointer-events:none}
  .thumb{width:100px;height:70px;object-fit:cover;border:1px solid #ccc;border-radius:6px;margin-top:6px}
  .btn{background:#0b63d6;color:#fff;padding:8px 14px;border:none;border-radius:8px;margin-top:8px;font-weight:600;cursor:pointer}
  .ok{color:green;font-weight:600}
  .bad{color:#c0392b;font-weight:600}
</style>
</head>
<body>
  <h2>Capture vehicle evidence</h2>

  <div class="slot">
    <h3>Front plate</h3>
    <button class="btn" onclick="startCapture('front')">Capture Front</button>
    <img id="thumb-front" class="thumb" style="display:none">
    <input id="ocr-front" placeholder="OCR result" style="width:100%;margin-top:6px">
  </div>

  <div class="slot">
    <h3>Back plate</h3>
    <button class="btn" onclick="startCapture('back')">Capture Back</button>
    <img id="thumb-back" class="thumb" style="display:none">
    <input id="ocr-back" placeholder="OCR result" style="width:100%;margin-top:6px">
  </div>

  <div class="slot">
    <h3>Engine / VIN</h3>
    <button class="btn" onclick="startCapture('engine')">Capture Engine</button>
    <img id="thumb-engine" class="thumb" style="display:none">
    <input id="ocr-engine" placeholder="OCR result" style="width:100%;margin-top:6px">
  </div>

  <div class="slot">
    <h3>Chassis / VIN</h3>
    <button class="btn" onclick="startCapture('chassis')">Capture Chassis</button>
    <img id="thumb-chassis" class="thumb" style="display:none">
    <input id="ocr-chassis" placeholder="OCR result" style="width:100%;margin-top:6px">
  </div>

  <div class="slot">
    <h3>Optional 360° Video</h3>
    <input type="file" id="videoFile" accept="video/*" capture="environment">
  </div>

  <div style="margin-top:10px">
    <input id="email" type="email" placeholder="Your email" style="width:100%;padding:8px">
    <input id="policy" type="text" placeholder="Policy number (optional)" style="width:100%;padding:8px;margin-top:6px">
  </div>

  <button class="btn" onclick="uploadAll()">Upload All</button>
  <div id="status" style="margin-top:12px"></div>

  <!-- hidden video + overlay for capture -->
  <div id="cameraWrap" style="display:none;position:fixed;left:0;top:0;width:100%;height:100%;background:#000;z-index:999">
    <video id="preview" autoplay playsinline style="width:100%;height:100%;object-fit:cover"></video>
    <div class="overlay"></div>
    <button class="btn" style="position:absolute;bottom:20px;left:50%;transform:translateX(-50%)" onclick="takePhoto()">Take Photo</button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
  <script>
  const WEBHOOK = "https://pmitsdubai.app.n8n.cloud/webhook/capture-upload"; 

  let currentSlot = null;
  let stream = null;

  function startCapture(slot){
    currentSlot = slot;
    document.getElementById('cameraWrap').style.display = 'block';
    navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}}).then(s=>{
      stream = s;
      document.getElementById('preview').srcObject = s;
    });
  }

  function takePhoto(){
    const video = document.getElementById('preview');
    const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    canvas.getContext('2d').drawImage(video,0,0);
    stream.getTracks().forEach(t=>t.stop());
    document.getElementById('cameraWrap').style.display='none';
    canvas.toBlob(async blob=>{
      const url = URL.createObjectURL(blob);
      document.getElementById('thumb-'+currentSlot).src = url;
      document.getElementById('thumb-'+currentSlot).style.display='inline-block';
      // OCR preview
      const { data:{text} } = await Tesseract.recognize(canvas,'eng');
      document.getElementById('ocr-'+currentSlot).value = (text||"").trim();
      document.getElementById('ocr-'+currentSlot).blob = blob; // store blob for upload
    },'image/jpeg',0.9);
  }

  async function uploadAll(){
    const email = document.getElementById('email').value;
    if(!email){ alert("Email required"); return; }
    const fd = new FormData();
    fd.append('email', email);
    fd.append('policyNumber', document.getElementById('policy').value||"");

    ['front','back','engine','chassis'].forEach(slot=>{
      const inp = document.getElementById('ocr-'+slot);
      if(inp.blob){
        fd.append(slot, inp.blob, slot+'.jpg');
      }
      fd.append('ocr.'+slot+'_text', inp.value||"");
    });
    if(document.getElementById('videoFile').files[0]){
      fd.append('video', document.getElementById('videoFile').files[0]);
    }

    document.getElementById('status').innerText="Uploading...";
    const res = await fetch(WEBHOOK,{method:'POST',body:fd});
    document.getElementById('status').innerText = res.ok ? "Uploaded successfully" : "Upload failed: "+res.status;
  }
  </script>
</body>
</html>
